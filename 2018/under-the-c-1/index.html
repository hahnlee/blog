<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
<meta http-equiv="x-ua-compatible" content="ie=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Under the C: 소개 | sn0wle0pard</title>
<link rel="stylesheet" href="/css/style.css">

    <link rel="stylesheet" href="/css/prism-okaidia.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>
    <body>
        <header class="header">
  <div class="header-container">
    <a class="blog-title" href="/">
      sn0wle0pard
    </a>
    <ul class="blog-nav">
      
        <li class="menu-item">
          <a href="/">Home</a>
        </li>
      
        <li class="menu-item">
          <a href="http://sn0wle0pard.io">About</a>
        </li>
      
    </ul>
  </div>
</header>
        <main class="container">
            <article id="article">
    <header id="article-title" class="text-center">
    <h1>Under the C: 소개</h1>
    <div id="time">
    <time datetime="2018-04-11T02:41:22.000Z" itemprop="datePublished">2018-04-11</time>
    </div>
</header>

<section>
    <h1 id="소개"><a href="#소개" class="headerlink" title="소개"></a>소개</h1><ul>
<li>Under the C 시리즈는 작년, 파이썬에 <a href="https://github.com/python/cpython/pull/3085" target="_blank" rel="noopener">아주 작은 기여</a>를 하며 공부한 내용을 정리한 글 입니다.</li>
<li>잘못된 내용을 알려주신다면, 최대한 빨리 수정하도록 하겠습니다</li>
<li>파이썬 구현체는 계속 발전하고 있으므로, 이 글의 내용과 다소 달라질 수 있습니다.</li>
<li>특별한 언급이 없다면, 파이썬은 공식 구현체인
<a href="https://github.com/python/cpython" target="_blank" rel="noopener">CPython</a>의 파이썬 3.x 구현을 의미합니다.</li>
</ul>
<h1 id="들어가며"><a href="#들어가며" class="headerlink" title="들어가며"></a>들어가며</h1><p>파이썬은 <code>인터프리터 언어</code>다. 사소한 말이지만 몇가지 사실을 품고 있다.
코드를 한줄 한줄 읽고 실행을 하는 인터프리터 언어는 컴파일 언어에 비해 최적화의 여지가 적다.</p>
<p>인터프리터 언어를 다룬다면, 같은 결과가 나오는 코드를 작성하여도,
프로그래머의 최적화, 언어의 이해도에 따라 꽤 다른 실행을 하는 코드를 작성할 수 있다.</p>
<p>몇가지 동일한 결과를 내는 파이썬 코드를 비교해보자.</p>
<h1 id="코드-최적화"><a href="#코드-최적화" class="headerlink" title="코드 최적화"></a>코드 최적화</h1><p>다음 코드를 보자.</p>
<pre class="line-numbers language-python"><code class="language-python">fruits <span class="token operator">=</span> dict<span class="token punctuation">(</span><span class="token punctuation">)</span>
fruits<span class="token punctuation">[</span><span class="token string">'apple'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span>
fruits<span class="token punctuation">[</span><span class="token string">'strawberry'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">20</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>빈 딕셔너리를 만들고 두쌍의 키-값을 할당했다. 위의 코드는 어떤 바이트 코드를 만들까?</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> dis <span class="token keyword">import</span> dis
code <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
fruits = dict()
fruits['apple'] = 10
fruits['strawberry'] = 20
'''</span>
co <span class="token operator">=</span> compile<span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token string">'&lt;string>'</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">)</span>
dis<span class="token punctuation">(</span>co<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>위 코드로 바이트 코드를 확인 할 수 있다. <code>dis</code> 모듈은 파이썬의 내장 모듈로, 바이트코드 역어셈블러 모듈이다.</p>
<p>위 코드를 인터프리터 모드에서 실행하면 다음와 같은 결과를 볼 수 있다.</p>
<pre class="line-numbers language-log"><code class="language-log">  2           0 LOAD_NAME                0 (dict)
              2 CALL_FUNCTION            0
              4 STORE_NAME               1 (fruits)

  3           6 LOAD_CONST               0 (10)
              8 LOAD_NAME                1 (fruits)
             10 LOAD_CONST               1 ('apple')
             12 STORE_SUBSCR

  4          14 LOAD_CONST               2 (20)
             16 LOAD_NAME                1 (fruits)
             18 LOAD_CONST               3 ('strawberry')
             20 STORE_SUBSCR
             22 LOAD_CONST               4 (None)
             24 RETURN_VALUE
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>딕셔너리를 만드는, 더 파이썬다운 코드는 제너릭을 이용하는 것 이다.</p>
<pre class="line-numbers language-python"><code class="language-python">fruits <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'apple'</span><span class="token punctuation">:</span> <span class="token number">10</span><span class="token punctuation">,</span>
    <span class="token string">'strawberry'</span><span class="token punctuation">:</span> <span class="token number">20</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<p>위 코드도 같은 바이트코드를 만들까? 한번 코드의 바이트코드를 한번 확인해보자.</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> dis <span class="token keyword">import</span> dis
code <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
fruits = {
    'apple': 10,
    'strawberry': 20,
}
'''</span>
co <span class="token operator">=</span> compile<span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token string">'&lt;string>'</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">)</span>
dis<span class="token punctuation">(</span>co<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-log"><code class="language-log">  3           0 LOAD_CONST               0 (10)

  4           2 LOAD_CONST               1 (20)
              4 LOAD_CONST               2 (('apple', 'strawberry'))
              6 BUILD_CONST_KEY_MAP      2
              8 STORE_NAME               0 (fruits)
             10 LOAD_CONST               3 (None)
             12 RETURN_VALUE
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>같은 역할을 하지만 서로 다른 바이트코드를 생성하는 것을 확인 할 수 있다. 사실 이 예제는 파이썬 입장에선 조금 억울 하고, 최적화가 쉽지 않을 수 있다.</p>
<p>좀 더 쉬워보이는 한가지 예를 더 살펴보자.
PyConKR 2017에서 차영호님이 라이트닝 토크 시간에 발표한,
<a href="https://docs.google.com/presentation/d/1mpgEviFIolgPLy3tYjK2DIEWRKT671vJdb4RCiXvCyY/" target="_blank" rel="noopener">Back to the Low Level</a>
에서 코드와 내용을 가져왔다.</p>
<pre class="line-numbers language-python"><code class="language-python">A <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token keyword">if</span> A <span class="token operator">!=</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> dis <span class="token keyword">import</span> dis
code <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
A = False
if A != True:
    pass
'''</span>
co <span class="token operator">=</span> compile<span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token string">'&lt;string>'</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">)</span>
dis<span class="token punctuation">(</span>co<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-log"><code class="language-log">  2           0 LOAD_CONST               0 (False)
              2 STORE_NAME               0 (A)

  3           4 LOAD_NAME                0 (A)
              6 LOAD_CONST               1 (True)
              8 COMPARE_OP               3 (!=)
             10 POP_JUMP_IF_FALSE       12

  4     >>   12 LOAD_CONST               2 (None)
             14 RETURN_VALUE
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>위 코드보다 더 파이썬 다운 코드는 아래와 같다. (조건문 실행여부를 이미 알고 있는건 넘어가자)</p>
<pre class="line-numbers language-python"><code class="language-python">A <span class="token operator">=</span> <span class="token boolean">False</span>
<span class="token keyword">if</span> <span class="token operator">not</span> A<span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> dis <span class="token keyword">import</span> dis
code <span class="token operator">=</span> <span class="token triple-quoted-string string">'''
A = False
if not A:
    pass
'''</span>
co <span class="token operator">=</span> compile<span class="token punctuation">(</span>code<span class="token punctuation">,</span> <span class="token string">'&lt;string>'</span><span class="token punctuation">,</span> <span class="token string">'exec'</span><span class="token punctuation">)</span>
dis<span class="token punctuation">(</span>co<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-log"><code class="language-log">  2           0 LOAD_CONST               0 (False)
              2 STORE_NAME               0 (A)

  3           4 LOAD_NAME                0 (A)
              6 POP_JUMP_IF_TRUE         8

  4     >>    8 LOAD_CONST               1 (None)
             10 RETURN_VALUE
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>위 코드는 매우 비슷하며, 같은 역할을 하지만, 두 코드는 서로 다른 바이트코드를 만들었고, 연산 횟수도 다르다.</p>
<h2 id="Under-the-C"><a href="#Under-the-C" class="headerlink" title="Under the C"></a>Under the C</h2><p>위의 두 코드를 C언어레벨에서 확인하면 더 두드러진 차이를 볼 수 있다.</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">if</span> A <span class="token operator">!=</span> <span class="token boolean">True</span><span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>파이썬 인터프리터에게 위 코드는 다음의 C 코드와 같다.</p>
<pre class="line-numbers language-c"><code class="language-c">PyObject <span class="token operator">*</span>T <span class="token operator">=</span> Py_True<span class="token punctuation">;</span>
<span class="token function">Py_INCREF</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
PyObject <span class="token operator">*</span>R <span class="token operator">=</span> <span class="token function">PyObject_Compare</span><span class="token punctuation">(</span>A<span class="token punctuation">,</span> T<span class="token punctuation">,</span> Py_NE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">Py_DECREF</span><span class="token punctuation">(</span>T<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyObject_IsTrue</span><span class="token punctuation">(</span>R<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span class="token function">Py_DECREF</span><span class="token punctuation">(</span>R<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>그리고 이 코드는</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">if</span> <span class="token operator">not</span> A<span class="token punctuation">:</span>
    <span class="token keyword">pass</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>다음의 코드와 같다</p>
<pre class="line-numbers language-c"><code class="language-c"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PyObject_Not</span><span class="token punctuation">(</span>A<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><a href="https://github.com/python/cpython/blob/master/Objects/object.c#L1401" target="_blank" rel="noopener">PyObject_Not</a>
함수는 내부에서 <code>PyObject_IsTrue</code>를 호출하고, 그 결과에 따라 다른 값을 반환한다.
단 그점을 고려해도, 여전히 <code>not</code>을 사용하는 코드는 <code>!= True</code>를 사용하는 코드보다 깔끔하다.</p>
<p>왜 파이썬 다운 코드를 작성해야하는지 이해할 수 있을 것이다.</p>
<h2 id="여담"><a href="#여담" class="headerlink" title="여담"></a>여담</h2><p>파이썬다운 코드가 항상 성능 향상을 약속하진 않다, 예를 들어 <code>elif</code>가 있다.</p>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> dis <span class="token keyword">import</span> dis

<span class="token keyword">def</span> <span class="token function">print_2</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> raw <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> raw <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

dis<span class="token punctuation">(</span>print_2<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-log"><code class="language-log">  2           0 LOAD_FAST                0 (raw)
              2 LOAD_CONST               1 (2)
              4 COMPARE_OP               2 (==)
              6 POP_JUMP_IF_FALSE       18

  3           8 LOAD_GLOBAL              0 (print)
             10 LOAD_FAST                0 (raw)
             12 CALL_FUNCTION            1
             14 POP_TOP
             16 JUMP_FORWARD            26 (to 44)

  5     >>   18 LOAD_FAST                0 (raw)
             20 LOAD_CONST               2 (1)
             22 COMPARE_OP               2 (==)
             24 POP_JUMP_IF_FALSE       36

  6          26 LOAD_GLOBAL              0 (print)
             28 LOAD_FAST                0 (raw)
             30 CALL_FUNCTION            1
             32 POP_TOP
             34 JUMP_FORWARD             8 (to 44)

  8     >>   36 LOAD_GLOBAL              0 (print)
             38 LOAD_CONST               1 (2)
             40 CALL_FUNCTION            1
             42 POP_TOP
        >>   44 LOAD_CONST               0 (None)
             46 RETURN_VALUE
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-python"><code class="language-python"><span class="token keyword">from</span> dis <span class="token keyword">import</span> dis

<span class="token keyword">def</span> <span class="token function">print_2</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">if</span> raw <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span>
    <span class="token keyword">elif</span> raw <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span>raw<span class="token punctuation">)</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span>

dis<span class="token punctuation">(</span>print_2<span class="token punctuation">)</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<pre class="line-numbers language-log"><code class="language-log">  2           0 LOAD_FAST                0 (raw)
              2 LOAD_CONST               1 (2)
              4 COMPARE_OP               2 (==)
              6 POP_JUMP_IF_FALSE       18

  3           8 LOAD_GLOBAL              0 (print)
             10 LOAD_FAST                0 (raw)
             12 CALL_FUNCTION            1
             14 POP_TOP
             16 JUMP_FORWARD            26 (to 44)

  4     >>   18 LOAD_FAST                0 (raw)
             20 LOAD_CONST               2 (1)
             22 COMPARE_OP               2 (==)
             24 POP_JUMP_IF_FALSE       36

  5          26 LOAD_GLOBAL              0 (print)
             28 LOAD_FAST                0 (raw)
             30 CALL_FUNCTION            1
             32 POP_TOP
             34 JUMP_FORWARD             8 (to 44)

  7     >>   36 LOAD_GLOBAL              0 (print)
             38 LOAD_CONST               1 (2)
             40 CALL_FUNCTION            1
             42 POP_TOP
        >>   44 LOAD_CONST               0 (None)
             46 RETURN_VALUE
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>줄번호는 다르지만 같은 바이트코드를 생성하는 걸 볼 수 있다.</p>
<h1 id="마치며"><a href="#마치며" class="headerlink" title="마치며"></a>마치며</h1><blockquote>
<p>섣부른 최적화는 만악의 근원이다 — 도널드 커누스</p>
</blockquote>
<p>사실 언어적 특성이 코딩에 미치는 영향보단, 프로그램의 로직이 더 중요하다고 생각한다.</p>
<p>그러나 파이썬 인터프리터 (C언어) 아래에서 일어나는 일을 이해한다면,
분명 더 나은 프로그래머가 될 수 있을 것이고, 재미있는 특성들도 알게 될 것이다.</p>
<p>다음에는 파이썬을 이해하는데 매우 중요한 <code>PyObject</code>를 다룰 예정이다.</p>

</section>
<footer id="article-footer">
    <div id="article-tag">
        
            
                <a href='/tags/Python/'>Python</a>
            
                <a href='/tags/Under-the-C/'>Under the C</a>
            
        
    </div>
</footer>
<div id="share">
    <div class="article-share-box">
    <span>SHARE THIS ARTICLE</span>
    <div class="article-share-links">
        <a 
            href="https://www.facebook.com/sharer.php?u="
            id="share-link-facebook"
            target="_blank" title="Facebook">
            <img src="/icon/facebook.svg"/>
        </a>
        <a
            href="https://twitter.com/intent/tweet?url="
            id="share-link-twitter"
            target="_blank" title="Twitter">
            <img src="/icon/twitter.svg"/>
        </a>
    </div>
</div>

</div>
<div class="fb-comments" data-href="https://blog.sn0wle0pard.io/2018/under-the-c-1/" data-width="100%" data-numposts="5"></div>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = 'https://connect.facebook.net/ko_KR/sdk.js#xfbml=1&version=v2.11&appId=155425561701021';
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
</article>


        </main>
        
        
        <script src="/js/share.js"></script>
        
        <script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
                (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
            ga('create', 'UA-89496100-1', 'auto');
            ga('send', 'pageview');
        </script>
        
    </body>
</html>
